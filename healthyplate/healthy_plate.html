<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balanced Plate Challenge</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
            background: #1a5276;
            display: flex;
        }
        #game-container {
            flex: 1;
            height: 100vh;
        }
        #progress-container {
            width: 250px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .progress-group {
            margin-bottom: 20px;
        }
        .progress-bar {
            height: 16px;
            background: #333;
            margin: 5px 0;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
        }
        .progress-label {
            color: white;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .progress-counter {
            color: white;
            text-align: right;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <div id="progress-container"></div>

    <script>
        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: 800,
            height: 600,
            backgroundColor: '#1a5276',
            physics: {
                default: 'arcade',
                arcade: { 
                    gravity: { y: 200 }, // Increased gravity for faster falling
                    debug: false,
                    checkCollision: {
                        left: true,
                        right: true,
                        up: true,
                        down: true
                    }
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            },
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH
            }
        };

        const game = new Phaser.Game(config);
        let plate, foods, cursors;
        const foodGroups = {
            'vegetables': { target: 3, caught: 0, icon: 'broccoli', color: '#4CAF50' },
            'fruits':     { target: 2, caught: 0, icon: 'apple', color: '#FF5722' },
            'proteins':   { target: 2, caught: 0, icon: 'fish', color: '#2196F3' },
            'grains':     { target: 2, caught: 0, icon: 'bread', color: '#FFEB3B' },
            'dairy':      { target: 1, caught: 0, icon: 'cheese', color: '#FFFFFF' }
        };

        function preload() {
            this.load.image('broccoli', 'broccoli.png');
            this.load.image('apple', 'apple.png');
            this.load.image('bread', 'bread.png');
            this.load.image('donut', 'donut.png');
            this.load.image('soda', 'soda.png');
            this.load.image('fish', 'fish.png');
            this.load.image('cheese', 'cheese.png');
        }

        function create() {
            // Create plate as rounded rectangle
            plate = this.add.rectangle(400, 550, 180, 30, 0xffffff, 1)
                .setStrokeStyle(3, 0x333333)
                .setOrigin(0.5);
            
            // Enable physics on plate
            this.physics.add.existing(plate);
            plate.body
                .setImmovable(true)
                .setCollideWorldBounds(true)
                .setSize(180, 30);

            // Food group with physics
            foods = this.physics.add.group();

            // Controls
            cursors = this.input.keyboard.createCursorKeys();
            this.input.on('pointermove', (pointer) => {
                // Adjust pointer x coordinate to account for the game container offset
                const gameBounds = this.scale.canvasBounds;
                const relativeX = (pointer.x - gameBounds.x) / (gameBounds.width / 800);
                plate.x = Phaser.Math.Clamp(relativeX, 90, 710);
            });

            // Create progress UI in the separate container
            createProgressUI();

            // Spawn foods only in the game area (not over the progress container)
            this.time.addEvent({
                delay: 800,
                callback: spawnFood,
                callbackScope: this,
                loop: true
            });

            // Collision handling
            this.physics.add.collider(plate, foods, (plate, food) => {
                const foodType = food.texture.key;
                const isHealthy = Object.values(foodGroups).some(g => g.icon === foodType);
                
                if (isHealthy) {
                    handleHealthyCatch(this, food);
                } else {
                    handleUnhealthyCatch(this);
                }
                food.destroy();
            });
            
            // Set world bounds to prevent foods from going into the progress area
            this.physics.world.setBounds(0, 0, 800, 600);
        }

        function spawnFood() {
            const neededGroups = Object.entries(foodGroups)
                .filter(([_,g]) => g.caught < g.target)
                .map(([name]) => name);
            
            const groupToSpawn = neededGroups.length > 0 
                ? Phaser.Math.RND.pick(neededGroups)
                : Phaser.Math.RND.pick(Object.keys(foodGroups));
            
            const isHealthy = Math.random() > 0.3;
            const foodType = isHealthy 
                ? foodGroups[groupToSpawn].icon 
                : Phaser.Math.RND.pick(['donut', 'soda']);
            
            // Create food with physics - spawn only in the game area (left of 750)
            const food = this.physics.add.image(
                Phaser.Math.Between(100, 700),
                -50,
                foodType
            ).setScale(0.7);
            
            // Set physics properties
            food.setVelocity(
                Phaser.Math.Between(-50, 50), 
                Phaser.Math.Between(50, 100)
            );
            food.setBounce(0.3);
            food.setCollideWorldBounds(true);
            
            // Add to foods group
            foods.add(food);
            
            // Remove if falls off bottom
            food.body.onWorldBounds = true;
            this.physics.world.on('worldbounds', (body) => {
                if (body.gameObject === food && body.blocked.down) {
                    food.destroy();
                }
            });
        }

        function handleHealthyCatch(scene, food) {
            // Find which food group this belongs to
            const group = Object.entries(foodGroups).find(([_,g]) => g.icon === food.texture.key)[0];
            foodGroups[group].caught++;
            
            // Squish and fade animation
            scene.tweens.add({
                targets: food,
                scaleX: 0.5,
                scaleY: 1.5,
                alpha: 0,
                duration: 300,
                ease: 'Quad.easeOut',
            });
            
            // Update progress
            updateProgressUI();
        }

        function handleUnhealthyCatch(scene) {
            // Plate shake animation
            scene.tweens.add({
                targets: plate,
                x: '+=10',
                yoyo: true,
                duration: 80,
                repeat: 2,
                ease: 'Sine.easeInOut'
            });
        }

        function update() {
            // Keyboard controls
            if (cursors.left.isDown) {
                plate.x = Phaser.Math.Clamp(plate.x - 10, 90, 710);
            } else if (cursors.right.isDown) {
                plate.x = Phaser.Math.Clamp(plate.x + 10, 90, 710);
            }
        }

        function createProgressUI() {
            const container = document.getElementById('progress-container');
            container.innerHTML = '';
            
            Object.entries(foodGroups).forEach(([name, group]) => {
                const groupEl = document.createElement('div');
                groupEl.className = 'progress-group';
                
                const labelEl = document.createElement('div');
                labelEl.className = 'progress-label';
                labelEl.textContent = name;
                
                const barEl = document.createElement('div');
                barEl.className = 'progress-bar';
                
                const fillEl = document.createElement('div');
                fillEl.className = 'progress-fill';
                fillEl.style.backgroundColor = group.color;
                fillEl.style.width = '0%';
                group.fillEl = fillEl;
                
                const counterEl = document.createElement('div');
                counterEl.className = 'progress-counter';
                counterEl.textContent = `0/${group.target}`;
                group.counterEl = counterEl;
                
                barEl.appendChild(fillEl);
                groupEl.appendChild(labelEl);
                groupEl.appendChild(barEl);
                groupEl.appendChild(counterEl);
                container.appendChild(groupEl);
            });
        }

        function updateProgressUI() {
            let allComplete = true;
            
            Object.entries(foodGroups).forEach(([name, group]) => {
                const progress = Math.min(group.caught / group.target, 1);
                const widthPercent = progress * 100;
                
                // Animate progress bar
                group.fillEl.style.width = `${widthPercent}%`;
                
                // Update counter
                group.counterEl.textContent = `${group.caught}/${group.target}`;
                
                if (group.caught < group.target) allComplete = false;
            });
            
            if (allComplete) {
                // Celebration effects
                game.scene.scenes[0].cameras.main.shake(400, 0.02);
                
                const congrats = game.scene.scenes[0].add.text(400, 300, 'Perfectly Balanced!', {
                    fontSize: '42px',
                    fill: '#4CAF50',
                    fontStyle: 'bold',
                    stroke: '#000000',
                    strokeThickness: 5
                }).setOrigin(0.5).setAlpha(0);
                
                game.scene.scenes[0].tweens.add({
                    targets: congrats,
                    alpha: 1,
                    scale: 1.2,
                    duration: 800,
                    ease: 'Elastic.out'
                });
                
                // Reset after delay
                game.scene.scenes[0].time.delayedCall(2500, () => {
                    Object.values(foodGroups).forEach(g => g.caught = 0);
                    updateProgressUI();
                    congrats.destroy();
                });
            }
        }
    </script>
</body>
</html>